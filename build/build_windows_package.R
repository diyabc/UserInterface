## build diyabcGUI zip package for Windows

## check OS
if(!R.version$os %in% c("mingw32", "windows"))
    stop("Windows standalone build can only be done on Windows OS")

# requirement: .Renviron file generated by 'generate_Renviron.R'
if(!file.exists(".Renviron"))
    stop("You should run 'generate_Renviron.R'")

# current working directory
cwd <- getwd()

# requirement
library(devtools)
library(fs)
library(gtools)
library(stringr)

# local install of diyabcGUI package
devtools::install(
    pkg = file.path(proj_dir, "R-pkg"),
    upgrade = "never"
)

# # remote install of diyabcGUI package
# devtools::install_github(
#     "diyabc/diyabcGUI",
#     subdir = "R-pkg",
#     ref = "prod",
#     upgrade = "never"
# )

# dependencies (jsonlite required by desktopDeployR)
dep <- sort(unique(c(
    "jsonlite",
    gtools::getDependencies(
        "diyabcGUI", 
        dependencies = c("Depends", "Imports", "LinkingTo")
    )
)))

write.table(
    dep, 
    file = file.path(dist_dir, "requirements.txt"), 
    row.names = FALSE, col.names = FALSE, quote = FALSE
)

# get latest required bin
library(diyabcGUI)
diyabcGUI::dl_all_latest_bin()

# version
pkg_version <- as.character(packageVersion("diyabcGUI"))

# write package version
writeLines(pkg_version, file.path(dist_dir, "version"))

# zip local install of package
zipfile <- file.path(dist_dir, str_c("diyabcGUI_", pkg_version, ".zip"))
if(file.exists(zipfile)) fs::file_delete(zipfile)
setwd(dirname(system.file(package = "diyabcGUI")))
on.exit(setwd(cwd))
zip(
    zipfile = zipfile, 
    files = basename(system.file(package = "diyabcGUI"))
)
